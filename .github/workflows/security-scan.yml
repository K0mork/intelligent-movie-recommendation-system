name: ğŸ”’ Security Scan - API Key Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  security-scan:
    name: ğŸ” API Key Detection Scan
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆéå»ã®ã‚³ãƒŸãƒƒãƒˆã‚‚ãƒã‚§ãƒƒã‚¯ï¼‰

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install pre-commit
      run: |
        pip install pre-commit

    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.7.2'
        channel: 'stable'

    - name: ğŸ” Run Pre-commit All Files
      run: |
        echo "ğŸ”’ Running pre-commit on all files..."
        pre-commit install
        pre-commit run --all-files

    - name: ğŸ” Scan for API Keys and Secrets
      run: |
        echo "ğŸ”’ FilmFlow Security Scan: APIã‚­ãƒ¼æ¤œå‡ºã‚’é–‹å§‹..."

        # ã‚«ãƒ©ãƒ¼å®šç¾©
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m'
        BOLD='\033[1m'

        # æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆJSONå½¢å¼ã§ç®¡ç†ï¼‰
        cat > patterns.json << 'EOF'
        {
          "patterns": [
            {
              "name": "Firebase API Key",
              "regex": "AIzaSy[0-9A-Za-z_-]{33}",
              "description": "Firebase API ã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            },
            {
              "name": "TMDb API Key",
              "regex": "[0-9a-f]{32}",
              "description": "TMDb API ã‚­ãƒ¼ï¼ˆ32æ–‡å­—hexï¼‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            },
            {
              "name": "Generic API Key",
              "regex": "[Aa][Pp][Ii]_?[Kk][Ee][Yy].*['\"][0-9A-Za-z_-]{20,}['\"]",
              "description": "æ±ç”¨APIã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            },
            {
              "name": "Secret Pattern",
              "regex": "[Ss][Ee][Cc][Rr][Ee][Tt].*['\"][0-9A-Za-z_-]{20,}['\"]",
              "description": "ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            },
            {
              "name": "Token Pattern",
              "regex": "[Tt][Oo][Kk][Ee][Nn].*['\"][0-9A-Za-z_-]{20,}['\"]",
              "description": "ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            }
          ]
        }
        EOF

        # é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³
        EXCLUDE_DIRS=".git|node_modules|build|.flutter-plugins|.dart_tool|coverage"
        EXCLUDE_FILES="*.log|*.md"

        # ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
        FOUND_SECRETS=0
        SCAN_RESULTS=""

        echo -e "${BLUE}ğŸ“ ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†ä¸­...${NC}"

        # å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆé™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ï¼‰
        find . -type f \
          ! -path "*/.git/*" \
          ! -path "*/node_modules/*" \
          ! -path "*/build/*" \
          ! -path "*/.dart_tool/*" \
          ! -path "*/coverage/*" \
          ! -name "*.log" \
          ! -name "security-scan.yml" \
          -print0 | while IFS= read -r -d '' file; do

          echo "ğŸ” Scanning: $file"

          # Firebase APIã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯
          if grep -Hn "AIzaSy[0-9A-Za-z_-]\{33\}" "$file" 2>/dev/null; then
            echo "ğŸš¨ Firebase API Key detected in: $file"
            FOUND_SECRETS=1
          fi

          # TMDb APIã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆé™¤å¤–æ¡ä»¶ä»˜ãï¼‰
          if grep -Hn "[0-9a-f]\{32\}" "$file" 2>/dev/null | grep -v -E "(YOUR_|PLACEHOLDER|EXAMPLE|TEST|TEMPLATE)" 2>/dev/null; then
            echo "ğŸš¨ Potential TMDb API Key detected in: $file"
            FOUND_SECRETS=1
          fi

          # å±é™ºãªæ–‡å­—åˆ—ãƒ‘ã‚¿ãƒ¼ãƒ³
          DANGEROUS_PATTERNS=(
            "firebase.*api.*key.*="
            "tmdb.*api.*key.*="
            "api_key.*=.*['\"][0-9a-zA-Z_-]{20,}['\"]"
            "apiKey.*=.*['\"][0-9a-zA-Z_-]{20,}['\"]"
          )

          for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -Hn -i -E "$pattern" "$file" 2>/dev/null | grep -v -E "(YOUR_|PLACEHOLDER|EXAMPLE|TEST|TEMPLATE)" 2>/dev/null; then
              echo "ğŸš¨ Dangerous pattern detected in: $file - $pattern"
              FOUND_SECRETS=1
            fi
          done
        done

        # ç‰¹åˆ¥ãªGitã‚³ãƒŸãƒƒãƒˆå±¥æ­´ãƒã‚§ãƒƒã‚¯
        echo -e "${YELLOW}ğŸ“š Gitå±¥æ­´ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...${NC}"

        # æœ€è¿‘ã®10ã‚³ãƒŸãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        git log --oneline -10 --pretty=format:"%h %s" | while read commit; do
          commit_hash=$(echo "$commit" | cut -d' ' -f1)

          # ã‚³ãƒŸãƒƒãƒˆã®å·®åˆ†ã‹ã‚‰ç§˜å¯†æƒ…å ±ã‚’æ¤œç´¢
          if git show "$commit_hash" | grep -E "AIzaSy[0-9A-Za-z_-]{33}|[0-9a-f]{32}" | grep -v -E "(YOUR_|PLACEHOLDER|EXAMPLE|TEST)" 2>/dev/null; then
            echo "âš ï¸  Potential secrets in commit: $commit"
            echo "   Consider rewriting history if this commit contains real secrets"
          fi
        done

        echo -e "\n${GREEN}ğŸ” ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†${NC}"

        # æœ€çµ‚çµæœ
        if [ $FOUND_SECRETS -eq 1 ]; then
          echo -e "\n${RED}${BOLD}ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ: æ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼${NC}"
          echo -e "${RED}ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ—ãƒƒã‚·ãƒ¥ã¯æ‹’å¦ã•ã‚Œã¾ã™ã€‚${NC}"
          echo -e "\n${YELLOW}å¯¾å¿œæ–¹æ³•:${NC}"
          echo -e "1. æ¤œå‡ºã•ã‚ŒãŸæ©Ÿå¯†æƒ…å ±ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„"
          echo -e "2. ç’°å¢ƒå¤‰æ•°(.env)ã¾ãŸã¯GitHub Secretsã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
          echo -e "3. ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼(YOUR_API_KEY)ã«ç½®ãæ›ãˆã¦ãã ã•ã„"
          exit 1
        else
          echo -e "\n${GREEN}${BOLD}âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯é€šé${NC}"
          echo -e "${GREEN}ğŸ”’ æ©Ÿå¯†æƒ…å ±ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ${NC}"
        fi

    - name: ğŸ“Š Security Report
      if: failure()
      run: |
        echo "::error title=Security Violation::API keys or secrets detected in the codebase"
        echo "::error::Please remove all hardcoded secrets and use environment variables or GitHub Secrets instead"

    - name: âœ… Security Check Passed
      if: success()
      run: |
        echo "::notice title=Security Check::No secrets detected - good job! ğŸ‰"
