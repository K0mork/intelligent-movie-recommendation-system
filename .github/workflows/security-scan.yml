# =========================================
#  🔒 Security Scan - API Key Detection
# =========================================
# 目的：
#   1.  pre-commit フックで静的解析を実行（verbose出力で原因を特定しやすく）
#   2.  独自シェルスクリプトで追加の API キー／シークレット探索
#   3.  いずれかで問題が見つかった場合はワークフロー全体を失敗させる
# =========================================

name: 🔒 Security Scan - API Key Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  security-scan:
    name: 🔍 API Key Detection Scan
    runs-on: ubuntu-latest

    steps:
    # ────────────────────────────────────
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        # セキュリティスキャン最適化: 直近コミットのみに制限
        fetch-depth: 1

    # ────────────────────────────────────
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # ────────────────────────────────────
    - name: 📦 Install pre-commit
      run: pip install pre-commit

    # ────────────────────────────────────
    - name: 🔧 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.2'
        channel: 'stable'

    # ────────────────────────────────────
    # ① pre-commit を verbose で実行
    #    continue-on-error: true にして後続ステップを必ず走らせる
    - name: 🔍 Run Pre-commit All Files
      continue-on-error: true
      id: precommit
      run: |
        echo "🔒 Running pre-commit (verbose, diff on failure)…"
        pre-commit install
        if pre-commit run --all-files --verbose --color always --show-diff-on-failure; then
          echo "exit_code=0" >> $GITHUB_OUTPUT
        else
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        fi

    # ────────────────────────────────────
    # ② カスタム grep スキャン
    - name: 🔍 Scan for API Keys and Secrets
      continue-on-error: true
      id: customscan
      run: |
        set -euo pipefail

        echo "🛡️  FilmFlow Security Scan: APIキー／シークレット検出を開始…"

        # ───── 色設定（ANSI）─────
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m'
        BOLD='\033[1m'

        # ───── 検索パターン定義（POSIX互換・精度向上版） ─────
        REGEX_LIST=(
          "AIzaSy[0-9A-Za-z_-]{33}"                # Firebase API Key
          "[0-9a-f]{32}[^0-9a-f]"                  # 32桁hex (境界文字で精緻化)
          "[Aa][Pp][Ii]_?[Kk][Ee][Yy].*[0-9A-Za-z_-]{20,}"  # 'API_KEY=' 等
          "[Ss][Ee][Cc][Rr][Ee][Tt].*[0-9A-Za-z_-]{20,}"    # 'SECRET=' 等
          "[Tt][Oo][Kk][Ee][Nn].*[0-9A-Za-z_-]{20,}"        # 'TOKEN=' 等
        )
        # ───── 除外キーワード（Mockito・テストファイル対応強化） ─────
        EXCLUDE_CONTENT='(YOUR_|PLACEHOLDER|EXAMPLE|TEST|TEMPLATE|MOCK|revokeToken|testtmdb|your_.*_api_key|your-.*-api-key|your_new_.*_api_key|your_gemini_api_key_here|sha256:|AWS_ACCESS_KEY_PATTERN|revision:|create_revision:|base_revision:|greaterThanOrEqualTo|equalTo|lessThan|length.*[0-9]{2,}|expect.*[0-9]{2,}|_Fake.*_[0-9]+|returnValue.*_i[0-9]+|\.mocks\.dart|_FakeIdTokenResult_|SmartFake)'

        echo -e "${BLUE}📝 スキャン対象ファイル収集中…${NC}"
        mapfile -d '' FILES < <(find . -type f \
          ! -path "*/.git/*" \
          ! -path "*/node_modules/*" \
          ! -path "*/build/*" \
          ! -path "*/.dart_tool/*" \
          ! -path "*/coverage/*" \
          ! -path "*/test/*" \
          ! -path "*/.githooks/*" \
          ! -path "./.env.example" \
          ! -path "./lib/firebase_options_template.dart" \
          ! -path "./CLAUDE.md" \
          ! -name "*.log" \
          ! -name "*.mocks.dart" \
          ! -name ".metadata" \
          ! -name "pubspec.lock" \
          -print0)

        FOUND=0

        echo -e "${BLUE}🔍 ワーキングツリーをスキャン中…${NC}"
        for file in "${FILES[@]}"; do
          for regex in "${REGEX_LIST[@]}"; do
            # エラーハンドリング強化：各正規表現を個別処理
            if grep -HnE "$regex" "$file" 2>/dev/null | grep -vE "$EXCLUDE_CONTENT" >/dev/null 2>&1; then
              echo -e "${RED}🚨 機密情報検出:${NC} ${file} (pattern: ${regex})"
              grep -HnE "$regex" "$file" 2>/dev/null | grep -vE "$EXCLUDE_CONTENT" || true
              FOUND=1
            fi
          done
        done

        echo -e "${YELLOW}📚 Git履歴（直近1コミット）をスキャン中…${NC}"
        if git rev-list --max-count=1 --all >/dev/null 2>&1; then
          git rev-list --max-count=1 --all | while read commit; do
            for regex in "${REGEX_LIST[@]}"; do
              # git grepのエラーハンドリング強化
              if git grep -E "$regex" "$commit" -- . 2>/dev/null | grep -vE "$EXCLUDE_CONTENT" >/dev/null 2>&1; then
                echo -e "${RED}⚠️  履歴内で機密情報検出:${NC} commit ${commit}"
                git grep -E "$regex" "$commit" -- . 2>/dev/null | grep -vE "$EXCLUDE_CONTENT" || true
                FOUND=1
              fi
            done
          done
        else
          echo -e "${YELLOW}ℹ️  Git履歴アクセスできないため、ワーキングツリーのみスキャン${NC}"
        fi

        echo -e "${GREEN}🔍 スキャン完了${NC}"

        if [[ $FOUND -eq 1 ]]; then
          echo -e "${RED}${BOLD}🚨 セキュリティアラート：機密情報が検出されました${NC}"
          echo "scan_result=failure" >> $GITHUB_OUTPUT
          exit 2  # exit code 2 = custom scan failure
        else
          echo -e "${GREEN}${BOLD}✅ カスタムスキャン：問題なし${NC}"
          echo "scan_result=success" >> $GITHUB_OUTPUT
        fi

    # ────────────────────────────────────
    # ③ 結果判定：どちらかが失敗していればジョブを失敗扱いにする
    - name: 🗂️  Aggregate results
      if: always()
      run: |
        PRECOMMIT_EXIT=${{ steps.precommit.outputs.exit_code }}
        CUSTOM_SCAN_RESULT=${{ steps.customscan.outputs.scan_result }}
        echo "pre-commit exit: ${PRECOMMIT_EXIT}"
        echo "custom scan result: ${CUSTOM_SCAN_RESULT}"

        # pre-commit が非ゼロ，または custom scan が failure ならエラー終了
        if [[ "${PRECOMMIT_EXIT}" != "0" || "${CUSTOM_SCAN_RESULT}" == "failure" ]]; then
          if [[ "${CUSTOM_SCAN_RESULT}" == "failure" ]]; then
            echo "::error title=Security Violation::API keys or secrets detected in the codebase"
            echo "::error::Remove hard-coded secrets, rewrite history if necessary, and store them in GitHub Secrets or environment variables."
          else
            echo "::error title=Pre-commit Failed::Pre-commit hooks failed. Check the logs for details."
            echo "::error::Run 'pre-commit run --all-files' locally to see and fix the issues."
          fi
          exit 1
        fi

    # ────────────────────────────────────
    - name: ✅ Security Check Passed
      if: success()
      run: |
        echo "::notice title=Security Check::No secrets detected - good job! 🎉"
