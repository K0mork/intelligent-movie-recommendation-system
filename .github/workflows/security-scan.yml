# =========================================
#  ğŸ”’ Security Scan - API Key Detection
# =========================================
# ç›®çš„ï¼š
#   1.  pre-commit ãƒ•ãƒƒã‚¯ã§é™çš„è§£æã‚’å®Ÿè¡Œï¼ˆverboseå‡ºåŠ›ã§åŸå› ã‚’ç‰¹å®šã—ã‚„ã™ãï¼‰
#   2.  ç‹¬è‡ªã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¿½åŠ ã® API ã‚­ãƒ¼ï¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¢ç´¢
#   3.  ã„ãšã‚Œã‹ã§å•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã‚’å¤±æ•—ã•ã›ã‚‹
# =========================================

name: ğŸ”’ Security Scan - API Key Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  security-scan:
    name: ğŸ” API Key Detection Scan
    runs-on: ubuntu-latest

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        # éå»ã‚³ãƒŸãƒƒãƒˆã‚‚å«ã‚ã¦ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ã«ã™ã‚‹ãŸã‚å±¥æ­´ã‚’å…¨å–å¾—
        fetch-depth: 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¦ Install pre-commit
      run: pip install pre-commit

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # â‘  pre-commit ã‚’ verbose ã§å®Ÿè¡Œ
    #    continue-on-error: true ã«ã—ã¦å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã‚’å¿…ãšèµ°ã‚‰ã›ã‚‹
    - name: ğŸ” Run Pre-commit All Files
      continue-on-error: true
      id: precommit
      run: |
        echo "ğŸ”’ Running pre-commit (verbose, diff on failure)â€¦"
        pre-commit install
        if pre-commit run --all-files --verbose --color always --show-diff-on-failure; then
          echo "exit_code=0" >> $GITHUB_OUTPUT
        else
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # â‘¡ ã‚«ã‚¹ã‚¿ãƒ  grep ã‚¹ã‚­ãƒ£ãƒ³
    - name: ğŸ” Scan for API Keys and Secrets
      continue-on-error: true
      id: customscan
      run: |
        set -euo pipefail

        echo "ğŸ›¡ï¸  FilmFlow Security Scan: APIã‚­ãƒ¼ï¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºã‚’é–‹å§‹â€¦"

        # â”€â”€â”€â”€â”€ è‰²è¨­å®šï¼ˆANSIï¼‰â”€â”€â”€â”€â”€
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m'
        BOLD='\033[1m'

        # â”€â”€â”€â”€â”€ æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³å®šç¾© â”€â”€â”€â”€â”€
        REGEX_LIST=(
          "AIzaSy[0-9A-Za-z_-]{33}"                # Firebase API Key
          "(?<!sha256: )[0-9a-f]{32}(?![0-9a-f])" # TMDb ãªã© 32æ¡ hex (SHA-256ä»¥å¤–)
          "[Aa][Pp][Ii]_?[Kk][Ee][Yy].*[0-9A-Za-z_-]{20,}"  # 'API_KEY=' ç­‰
          "[Ss][Ee][Cc][Rr][Ee][Tt].*[0-9A-Za-z_-]{20,}"    # 'SECRET=' ç­‰
          "[Tt][Oo][Kk][Ee][Nn].*[0-9A-Za-z_-]{20,}"        # 'TOKEN=' ç­‰
        )
        # â”€â”€â”€â”€â”€ é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¤§å¹…å¼·åŒ–ï¼‰ â”€â”€â”€â”€â”€
        EXCLUDE_CONTENT='(YOUR_|PLACEHOLDER|EXAMPLE|TEST|TEMPLATE|MOCK|revokeToken|testtmdb|your_.*_api_key|your-.*-api-key|your_new_.*_api_key|your_gemini_api_key_here|sha256:|AWS_ACCESS_KEY_PATTERN|revision:|create_revision:|base_revision:)'

        echo -e "${BLUE}ğŸ“ ã‚¹ã‚­ãƒ£ãƒ³å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«åé›†ä¸­â€¦${NC}"
        mapfile -d '' FILES < <(find . -type f \
          ! -path "*/.git/*" \
          ! -path "*/node_modules/*" \
          ! -path "*/build/*" \
          ! -path "*/.dart_tool/*" \
          ! -path "*/coverage/*" \
          ! -path "*/test/*" \
          ! -path "*/.githooks/*" \
          ! -path "./.env.example" \
          ! -path "./lib/firebase_options_template.dart" \
          ! -path "./CLAUDE.md" \
          ! -name "*.log" \
          ! -name "*.mocks.dart" \
          ! -name ".metadata" \
          ! -name "pubspec.lock" \
          -print0)

        FOUND=0

        echo -e "${BLUE}ğŸ” ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ„ãƒªãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦${NC}"
        for file in "${FILES[@]}"; do
          for regex in "${REGEX_LIST[@]}"; do
            if grep -HnEI "$regex" "$file" | grep -vE "$EXCLUDE_CONTENT" >/dev/null 2>&1; then
              echo -e "${RED}ğŸš¨ æ©Ÿå¯†æƒ…å ±æ¤œå‡º:${NC} ${file} (pattern: ${regex})"
              grep -HnEI "$regex" "$file" | grep -vE "$EXCLUDE_CONTENT" || true
              FOUND=1
            fi
          done
        done

        echo -e "${YELLOW}ğŸ“š Gitå±¥æ­´ï¼ˆç›´è¿‘5ã‚³ãƒŸãƒƒãƒˆï¼‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦${NC}"
        git rev-list --max-count=5 --all | while read commit; do
          for regex in "${REGEX_LIST[@]}"; do
            if git grep -nE "$regex" "$commit" -- . | grep -vE "$EXCLUDE_CONTENT" >/dev/null 2>&1; then
              echo -e "${RED}âš ï¸  å±¥æ­´å†…ã§æ©Ÿå¯†æƒ…å ±æ¤œå‡º:${NC} commit ${commit}"
              git grep -nE "$regex" "$commit" -- . | grep -vE "$EXCLUDE_CONTENT" || true
              FOUND=1
            fi
          done
        done

        echo -e "${GREEN}ğŸ” ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†${NC}"

        if [[ $FOUND -eq 1 ]]; then
          echo -e "${RED}${BOLD}ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆï¼šæ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ${NC}"
          echo "scan_result=failure" >> $GITHUB_OUTPUT
          exit 2  # exit code 2 = custom scan failure
        else
          echo -e "${GREEN}${BOLD}âœ… ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ£ãƒ³ï¼šå•é¡Œãªã—${NC}"
          echo "scan_result=success" >> $GITHUB_OUTPUT
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # â‘¢ çµæœåˆ¤å®šï¼šã©ã¡ã‚‰ã‹ãŒå¤±æ•—ã—ã¦ã„ã‚Œã°ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—æ‰±ã„ã«ã™ã‚‹
    - name: ğŸ—‚ï¸  Aggregate results
      if: always()
      run: |
        PRECOMMIT_EXIT=${{ steps.precommit.outputs.exit_code }}
        CUSTOM_SCAN_RESULT=${{ steps.customscan.outputs.scan_result }}
        echo "pre-commit exit: ${PRECOMMIT_EXIT}"
        echo "custom scan result: ${CUSTOM_SCAN_RESULT}"

        # pre-commit ãŒéã‚¼ãƒ­ï¼Œã¾ãŸã¯ custom scan ãŒ failure ãªã‚‰ã‚¨ãƒ©ãƒ¼çµ‚äº†
        if [[ "${PRECOMMIT_EXIT}" != "0" || "${CUSTOM_SCAN_RESULT}" == "failure" ]]; then
          echo "::error title=Security Violation::API keys or secrets detected in the codebase"
          echo "::error::Remove hard-coded secretsï¼Œrewrite history if necessaryï¼Œand store them in GitHub Secrets or environment variablesï¼"
          exit 1
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœ… Security Check Passed
      if: success()
      run: |
        echo "::notice title=Security Check::No secrets detected - good job! ğŸ‰"
