#!/usr/bin/env bash
# FilmFlow API Key Detection Pre-commit Hook
# Prevents accidental commits of API keys and other secrets
# --------------------------------------------------------
# 2025-06-24  Refactored for reliability & maintainability

set -euo pipefail

printf "ğŸ” FilmFlow Security Check: APIã‚­ãƒ¼æ¤œå‡ºã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­...\n"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Colour definitions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'  # No colour

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Secret-looking patterns (ECMAScript-style regex)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PATTERNS=(
  # Firebase Web API key (starts with AIzaSy + 35 chars)
  "AIzaSy[0-9A-Za-z_-]{33}"
  # 32-char hex strings (e.g. TMDB keys)
  "[0-9a-fA-F]{32}"
  # Generic *_API_KEY or *_KEY assignments
  "[A-Za-z0-9_]*API[_-]?KEY[[:space:]]*=[[:space:]]*['\"][0-9A-Za-z_-]{20,}['\"]"
  # *_SECRET= or *_TOKEN=
  "[A-Za-z0-9_]*SECRET[[:space:]]*=[[:space:]]*['\"][0-9A-Za-z_-]{20,}['\"]"
  "[A-Za-z0-9_]*TOKEN[[:space:]]*=[[:space:]]*['\"][0-9A-Za-z_-]{20,}['\"]"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Allowed placeholders (exact string match)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ALLOWED_PATTERNS=(
  "YOUR_API_KEY"
  "YOUR_FIREBASE_API_KEY"
  "YOUR_TMDB_API_KEY"
  "<FIREBASE_API_KEY_PLACEHOLDER>"
  "<TMDB_API_KEY_PLACEHOLDER>"
  "<API_KEY_PLACEHOLDER>"
  "PLACEHOLDER"
  "EXAMPLE"
  "TEST_KEY"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Paths to exclude from scanning (shell globs)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EXCLUDE_GLOBS=(
  ".git/*"
  "node_modules/*"
  "build/*"
  ".dart_tool/*"
  "coverage/*"
  "*.log"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helper functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
contains_allowed() {
  local line="$1"
  for allow in "${ALLOWED_PATTERNS[@]}"; do
    if grep -qF -- "${allow}" <<< "${line}"; then
      return 0  # allowed
    fi
  done
  return 1  # not allowed
}

should_skip_file() {
  local file="$1"
  for glob in "${EXCLUDE_GLOBS[@]}"; do
    case "${file}" in
      ${glob}) return 0 ;; # skip
    esac
  done
  return 1  # do not skip
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Collect staged files
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STAGED_FILES=()
while IFS= read -r file; do
  STAGED_FILES+=("$file")
done < <(git diff --cached --name-only --diff-filter=ACMR)

if [[ ${#STAGED_FILES[@]} -eq 0 ]]; then
  printf "${GREEN}âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“${NC}\n"
  exit 0
fi

printf "${YELLOW}ğŸ“ ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: %dä»¶${NC}\n" "${#STAGED_FILES[@]}"

FOUND=0
REPORT_FILE="$(mktemp)"

for file in "${STAGED_FILES[@]}"; do
  # Exclude patterns & missing files
  should_skip_file "${file}" && continue
  [[ -f "${file}" ]] || continue

  printf "ğŸ” ãƒã‚§ãƒƒã‚¯ä¸­: %s\n" "${file}"

  # Search each pattern
  for pattern in "${PATTERNS[@]}"; do
    matches=$(grep -I -n -E -- "${pattern}" "${file}" || true)
    [[ -z "${matches}" ]] && continue
    while IFS= read -r line; do
      if ! contains_allowed "${line}"; then
        printf "${RED}ğŸš¨ APIã‚­ãƒ¼æ¤œå‡º: %s${NC}\n" "${file}" >> "${REPORT_FILE}"
        printf "${RED}   ãƒ‘ã‚¿ãƒ¼ãƒ³: %s${NC}\n" "${pattern}" >> "${REPORT_FILE}"
        printf "${RED}   ãƒãƒƒãƒ: %s${NC}\n" "${line}" >> "${REPORT_FILE}"
        FOUND=1
      fi
    done <<< "${matches}"
  done

done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Result
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ ${FOUND} -eq 1 ]]; then
  printf "\n${RED}${BOLD}ğŸš¨ğŸš¨ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ ğŸš¨ğŸš¨ğŸš¨${NC}\n"
  printf "${RED}${BOLD}APIã‚­ãƒ¼ã¾ãŸã¯æ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼${NC}\n\n"
  cat "${REPORT_FILE}"
  printf "\n${YELLOW}${BOLD}ğŸ“‹ å¯¾å¿œæ–¹æ³•:${NC}\n"
  printf "1. æ¤œå‡ºã•ã‚ŒãŸAPIã‚­ãƒ¼ã‚’å‰Šé™¤ï¼ç½®æ›ã—ã¦ãã ã•ã„\n"
  printf "2. ç’°å¢ƒå¤‰æ•°(.env)ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„\n"
  printf "3. ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€(YOUR_API_KEY ãªã©)ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„\n"
  printf "4. å¿…è¦ã«å¿œã˜ã¦ .gitignore ã«è¿½åŠ ã—ã¦ãã ã•ã„\n\n"
  printf "${RED}${BOLD}ã‚³ãƒŸãƒƒãƒˆã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚${NC}\n"
  rm -f "${REPORT_FILE}"
  exit 1
fi

printf "\n${GREEN}${BOLD}âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†${NC}\n"
printf "${GREEN}ğŸ”’ APIã‚­ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ${NC}\n"
printf "${GREEN}ğŸš€ ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™${NC}\n"

rm -f "${REPORT_FILE}"
exit 0
